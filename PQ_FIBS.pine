//@version=6
indicator(title = 'Fibonacci Pivots [PQ_MOD] + Stat Position', shorttitle = 'FIBS0.1.26', overlay = true, format = format.price, max_lines_count = 500, max_labels_count = 500, max_boxes_count = 500)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Colors
COLOR_FG_MAIN       = chart.fg_color
COLOR_RED           = #f44336
COLOR_GREEN         = #4caf50
COLOR_TEAL          = #009688
COLOR_BLUE          = #2196f3
COLOR_PURPLE        = #9c27b0
COLOR_PINK          = #e91e63
COLOR_GRAY          = #a2a2a2
COLOR_LIGHT_GREEN   = #81c784
COLOR_LIGHT_BLUE    = #64b5f6

// Theme Transparencies
TRANS_MAIN          = 25
TRANS_SUPP          = 70

// Static Colors
COLOR_TZ            = color.new(COLOR_FG_MAIN, 80)
COLOR_ZZ            = color.new(COLOR_FG_MAIN, 75)
COLOR_TEXT          = color.new(COLOR_FG_MAIN, 0)

// Configuration Constants
LEVELS_COUNT        = 22

// Alert IDs
ALERT_ID_UPDATE     = 'FBU'
ALERT_ID_EXHAUSTION = 'EXH'
ALERT_ID_VOLATILITY = 'HVO'
ALERT_ID_CROSSING   = 'RCL'

// Tooltips
TOOLTIP_THRESHOLD   = 'Deviation is a multiplier that affects how much the price should deviate from the previous pivot in order for the bar to become a new pivot\n\nDepth affects the minimum number of bars that will be taken into account when building'
TOOLTIP_PIVOT_POINT = 'A pivot point is a technical analysis indicator used to determine the overall trend of the market over different time frames'
TOOLTIP_ZIGZAG      = 'The Zig Zag indicator is used to identify price trends then connected by straight lines that help the trader visual the price action.'
TOOLTIP_VOL_EXHAUST = 'Moments where huge volume detected'
TOOLTIP_HIGH_VOL    = 'Moments where price range of the current bar is greater than average true range'
TOOLTIP_STAT_POS    = 'Calculates the Statistical "Golden Pocket" (0.618-0.65) entry zone.\n\nStop Loss is placed at the Pivot Start (Invalidation) adjusted by an ATR variance to prevent Stop Hunting.\n\nTake Profit targets the Pivot End (Conservative) or 1.272 Extension (Aggressive).'

// Groups
GROUP_PICK          = 'Pick a Fibonacci Tool'
GROUP_PIVOT         = 'Fibonacci Pivot Points Settings'
GROUP_THRESH_SEC    = 'Threshold (sec)'
GROUP_THRESH_MIN    = 'Threshold (minutes)'
GROUP_THRESH_H      = 'Threshold (hours)'
GROUP_THRESH_D      = 'Threshold (days)'
GROUP_THRESH_W      = 'Threshold (weeks)'
GROUP_THRESH_M      = 'Threshold (months)'
GROUP_DEPTH_SEC     = 'Depth (seconds)'
GROUP_DEPTH_MIN     = 'Depth (minutes)'
GROUP_DEPTH_H       = 'Depth (hours)'
GROUP_DEPTH_D       = 'Depth (days)'
GROUP_DEPTH_W       = 'Depth (weeks)'
GROUP_DEPTH_M       = 'Depth (months)'
GROUP_FIB_TOOL      = 'Fibonacci Extention / Retracement / TimeZone Settings'
GROUP_FIB_LEVELS    = 'Fibonacci Levels'
GROUP_ZIGZAG        = 'ZigZag Settings'
GROUP_VOL_VOL       = 'Volume / Volatility AddOns'
GROUP_ALERTS        = 'Alerts'
GROUP_STAT_POS      = 'Statistical Position Engine'

/// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

INPUT_SHOW_FIB_TIME     = input.bool(true, 'Fib Time Zones', inline='TZ', group=GROUP_PICK)
INPUT_CUSTOM_THRESHOLD  = input.bool(true, 'Custom thresholds', inline='C')
INPUT_CUSTOM_DEPTH      = input.bool(true, 'Custom depths', inline='C')

// Pivot Settings
INPUT_HTF_MODE          = input.string('Auto', 'Pivot Points TimeFrame', options=['Auto', 'User Defined'], inline='HTF', group=GROUP_PIVOT, tooltip=TOOLTIP_PIVOT_POINT)
INPUT_HTF_USER_RAW      = input.string('15 Min', '‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉ‚ÄÉor User Defined', options=['15 Min', '1 Hour', '4 Hour', 'Daily', 'Weekly', 'Monthly', 'Quarterly', 'Yearly'], inline='HTF1', group=GROUP_PIVOT)

// Parse HTF input
htf_user_parsed = INPUT_HTF_USER_RAW == '15 Min'? '15' : 
                  INPUT_HTF_USER_RAW == '1 Hour'? '60' : 
                  INPUT_HTF_USER_RAW == '4 Hour'? '240' : 
                  INPUT_HTF_USER_RAW == 'Daily'? 'D' : 
                  INPUT_HTF_USER_RAW == 'Weekly'? 'W' : 
                  INPUT_HTF_USER_RAW == 'Monthly'? 'M' : 
                  INPUT_HTF_USER_RAW == 'Quarterly'? '3M' : '12M'

INPUT_LEVELS_PVT        = input.string('Prices', 'Level Labels', options=['Levels', 'Prices', 'Levels + Prices', 'None'], inline='pvt', group=GROUP_PIVOT)
INPUT_LEVELS_PVT_POS    = input.string('Pivot End', '', options=['Last Bar', 'Pivot End'], inline='pvt', group=GROUP_PIVOT)
INPUT_LEVELS_PVT_SIZE   = input.string('Small', '', options=['Small', 'Normal'], inline='pvt', group=GROUP_PIVOT)
INPUT_EXTEND_PVT        = input.bool(false, 'Extend Pivot Point Lines', inline='fLines', group=GROUP_PIVOT)

// Deviation Thresholds
dev_treshold(float dev_treshold) => ta.atr(2) / close * 100 * dev_treshold
INPUT_DEV_THRESH_DEFAULT = dev_treshold(input.float(2.0, 'Deviation (default)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC, tooltip=TOOLTIP_THRESHOLD))
INPUT_DEV_THRESH_1S     = dev_treshold(input.float(2.0, 'Deviation (1S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_5S     = dev_treshold(input.float(2.0, 'Deviation (5S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_10S    = dev_treshold(input.float(2.0, 'Deviation (10S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_15S    = dev_treshold(input.float(2.0, 'Deviation (15S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_30S    = dev_treshold(input.float(2.0, 'Deviation (30S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_45S    = dev_treshold(input.float(2.0, 'Deviation (45S)', minval=0, inline='Pivots', group=GROUP_THRESH_SEC))
INPUT_DEV_THRESH_1M     = dev_treshold(input.float(2.0, 'Deviation (1M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_2M     = dev_treshold(input.float(2.0, 'Deviation (2M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_3M     = dev_treshold(input.float(2.0, 'Deviation (3M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_5M     = dev_treshold(input.float(2.0, 'Deviation (5M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_10M    = dev_treshold(input.float(2.0, 'Deviation (10M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_15M    = dev_treshold(input.float(2.0, 'Deviation (15M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_30M    = dev_treshold(input.float(2.0, 'Deviation (30M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_45M    = dev_treshold(input.float(2.0, 'Deviation (45M)', minval=0, inline='Pivots', group=GROUP_THRESH_MIN))
INPUT_DEV_THRESH_1H     = dev_treshold(input.float(2.0, 'Deviation (1H)', minval=0, inline='Pivots', group=GROUP_THRESH_H))
INPUT_DEV_THRESH_2H     = dev_treshold(input.float(2.0, 'Deviation (2H)', minval=0, inline='Pivots', group=GROUP_THRESH_H))
INPUT_DEV_THRESH_3H     = dev_treshold(input.float(2.0, 'Deviation (3H)', minval=0, inline='Pivots', group=GROUP_THRESH_H))
INPUT_DEV_THRESH_4H     = dev_treshold(input.float(2.0, 'Deviation (4H)', minval=0, inline='Pivots', group=GROUP_THRESH_H))
INPUT_DEV_THRESH_1D     = dev_treshold(input.float(2.0, 'Deviation (1D)', minval=0, inline='Pivots', group=GROUP_THRESH_D))
INPUT_DEV_THRESH_7D     = dev_treshold(input.float(2.0, 'Deviation (7D)', minval=0, inline='Pivots', group=GROUP_THRESH_D))
INPUT_DEV_THRESH_4W     = dev_treshold(input.float(2.0, 'Deviation (4W)', minval=0, inline='Pivots', group=GROUP_THRESH_W))
INPUT_DEV_THRESH_3MO    = dev_treshold(input.float(2.0, 'Deviation (3M)', minval=0, inline='Pivots', group=GROUP_THRESH_M))
INPUT_DEV_THRESH_6MO    = dev_treshold(input.float(2.0, 'Deviation (6M)', minval=0, inline='Pivots', group=GROUP_THRESH_M))
INPUT_DEV_THRESH_12MO   = dev_treshold(input.float(2.0, 'Deviation (12M)', minval=0, inline='Pivots', group=GROUP_THRESH_M))

// Depths
INPUT_DEPTH_DEFAULT     = input.int(10, 'Depth (default)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_1S          = input.int(10, 'Depth (1S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_5S          = input.int(10, 'Depth (5S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_10S         = input.int(10, 'Depth (10S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_15S         = input.int(10, 'Depth (15S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_30S         = input.int(10, 'Depth (30S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_45S         = input.int(10, 'Depth (45S)', minval=1, inline='Pivots', group=GROUP_DEPTH_SEC)
INPUT_DEPTH_1M          = input.int(10, 'Depth (1M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_2M          = input.int(10, 'Depth (2M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_3M          = input.int(10, 'Depth (3M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_5M          = input.int(10, 'Depth (5M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_10M         = input.int(10, 'Depth (10M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_15M         = input.int(10, 'Depth (15M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_30M         = input.int(10, 'Depth (30M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_45M         = input.int(10, 'Depth (45M)', minval=1, inline='Pivots', group=GROUP_DEPTH_MIN)
INPUT_DEPTH_1H          = input.int(10, 'Depth (1H)', minval=1, inline='Pivots', group=GROUP_DEPTH_H)
INPUT_DEPTH_2H          = input.int(10, 'Depth (2H)', minval=1, inline='Pivots', group=GROUP_DEPTH_H)
INPUT_DEPTH_3H          = input.int(10, 'Depth (3H)', minval=1, inline='Pivots', group=GROUP_DEPTH_H)
INPUT_DEPTH_4H          = input.int(10, 'Depth (4H)', minval=1, inline='Pivots', group=GROUP_DEPTH_H)
INPUT_DEPTH_1D          = input.int(10, 'Depth (1D)', minval=1, inline='Pivots', group=GROUP_DEPTH_D)
INPUT_DEPTH_7D          = input.int(10, 'Depth (7D)', minval=1, inline='Pivots', group=GROUP_DEPTH_D)
INPUT_DEPTH_4W          = input.int(10, 'Depth (4W)', minval=1, inline='Pivots', group=GROUP_DEPTH_W)
INPUT_DEPTH_3MO         = input.int(10, 'Depth (3M)', minval=1, inline='Pivots', group=GROUP_DEPTH_M)
INPUT_DEPTH_6MO         = input.int(10, 'Depth (6M)', minval=1, inline='Pivots', group=GROUP_DEPTH_M)
INPUT_DEPTH_12MO        = input.int(10, 'Depth (12M)', minval=1, inline='Pivots', group=GROUP_DEPTH_M)

// Fibonacci Tools
INPUT_LEVELS_LABEL      = input.string('Prices', 'Level Labels', options=['Levels', 'Prices', 'Levels + Prices', 'None'], inline='fLines', group=GROUP_FIB_TOOL)
INPUT_LEVELS_POS        = input.string('Pivot Start', '', options=['Last Bar', 'Pivot Start'], inline='fLines', group=GROUP_FIB_TOOL)
INPUT_LEVELS_SIZE       = input.string('Small', '', options=['Small', 'Normal'], inline='fLines', group=GROUP_FIB_TOOL)
INPUT_REVERSE           = input.bool(false, 'Reverse Extention / Retracement Levels', group=GROUP_FIB_TOOL)
INPUT_EXTEND_ER         = input.bool(false, 'Extend Extention / Retracement Lines', inline='fLine', group=GROUP_FIB_TOOL)
INPUT_HIST_PIVOT        = input.int (0, 'Historical Extention / Retracement Levels', minval=0, group=GROUP_FIB_TOOL)
INPUT_HIST_PIVOT_2      = input.int(0, 'Historical Time Zones', minval=0, group=GROUP_FIB_TOOL)
INPUT_FIB_TZ_LABEL      = input.bool(false, 'Time Zone Lables', inline='tz poz', group=GROUP_FIB_TOOL)
INPUT_FIB_TZ_POS_X      = input.string('Left', '', options=['Right', 'Left'], inline='tz poz', group=GROUP_FIB_TOOL)
fib_tzlp                = INPUT_FIB_TZ_POS_X == 'Left' ? label.style_label_left : label.style_label_right
INPUT_FIB_TZ_POS_Y      = input.string('Bottom', '', options=['Bottom', 'Top'], inline='tz poz', group=GROUP_FIB_TOOL)

// --- STATISTICAL POSITION ENGINE INPUTS ---
INPUT_SHOW_POS          = input.bool(true, 'Show Stat Position Preview', group=GROUP_STAT_POS, tooltip=TOOLTIP_STAT_POS)
INPUT_POS_SL_MULT       = input.float(1.5, 'Stop Loss Variance (ATR Mult)', minval=0.1, step=0.1, group=GROUP_STAT_POS, tooltip="Buffer added to the Structural Invalidation Point (Pivot Start) to prevent Stop Hunts.")
INPUT_POS_TP_MODE       = input.string('Conservative', 'Take Profit Mode', options=['Conservative', 'Aggressive'], group=GROUP_STAT_POS, tooltip="Conservative: Targets Pivot End (0.0).\nAggressive: Targets 1.272 Extension.")
// ------------------------------------------

// Fibonacci Levels
INPUT_SHOW_0            = input.bool(true, '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_VAL_0             = input.float(0., '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_COL_0             = input.color(color.new(COLOR_GRAY, TRANS_MAIN), '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_236        = input.bool(true, '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_236         = input.float(0.236, '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_COL_0_236         = input.color(color.new(COLOR_RED, TRANS_MAIN), '', inline='Level0', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_382        = input.bool(true, '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_382         = input.float(0.382, '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_COL_0_382         = input.color(color.new(COLOR_LIGHT_GREEN, TRANS_MAIN), '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_5          = input.bool(true, '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_5           = input.float(0.5, '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_COL_0_5           = input.color(color.new(COLOR_GREEN, TRANS_MAIN), '', inline='Level1', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_618        = input.bool(true, '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_618         = input.float(0.618, '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_COL_0_618         = input.color(color.new(COLOR_TEAL, TRANS_MAIN), '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_65         = input.bool(true, '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_65          = input.float(0.65, '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_COL_0_65          = input.color(color.new(COLOR_TEAL, TRANS_SUPP), '', inline='Level2', group=GROUP_FIB_LEVELS)
INPUT_SHOW_0_786        = input.bool(true, '', inline='Level3', group=GROUP_FIB_LEVELS)
INPUT_VAL_0_786         = input.float(0.786, '', inline='Level3', group=GROUP_FIB_LEVELS)
INPUT_COL_0_786         = input.color(color.new(COLOR_LIGHT_BLUE, TRANS_MAIN), '', inline='Level3', group=GROUP_FIB_LEVELS)
INPUT_SHOW_1            = input.bool(true, '', inline='Level3', group=GROUP_FIB_LEVELS)
INPUT_VAL_1             = input.float(1., '', inline='Level3', group=GROUP_FIB_LEVELS)
INPUT_COL_1             = input.color(color.new(#787b86, 15), '', inline='Level3', group=GROUP_FIB_LEVELS) 
INPUT_SHOW_1_272        = input.bool(true, '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_VAL_1_272         = input.float(1.272, '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_COL_1_272         = input.color(color.new(COLOR_LIGHT_GREEN, TRANS_MAIN), '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_SHOW_1_414        = input.bool(false, '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_VAL_1_414         = input.float(1.414, '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_COL_1_414         = input.color(color.new(COLOR_RED, TRANS_SUPP), '', inline='Level4', group=GROUP_FIB_LEVELS)
INPUT_SHOW_1_618        = input.bool(true, '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_VAL_1_618         = input.float(1.618, '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_COL_1_618         = input.color(color.new(COLOR_BLUE, TRANS_MAIN), '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_SHOW_1_65         = input.bool(false, '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_VAL_1_65          = input.float(1.65, '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_COL_1_65          = input.color(color.new(COLOR_BLUE, TRANS_SUPP), '', inline='Level5', group=GROUP_FIB_LEVELS)
INPUT_SHOW_2_618        = input.bool(false, '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_VAL_2_618         = input.float(2.618, '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_COL_2_618         = input.color(color.new(COLOR_RED, TRANS_SUPP), '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_SHOW_2_65         = input.bool(true, '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_VAL_2_65          = input.float(2.65, '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_COL_2_65          = input.color(color.new(COLOR_RED, TRANS_SUPP), '', inline='Level6', group=GROUP_FIB_LEVELS)
INPUT_SHOW_3_618        = input.bool(false, '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_VAL_3_618         = input.float(3.618, '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_COL_3_618         = input.color(color.new(COLOR_PURPLE, TRANS_SUPP), '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_SHOW_3_65         = input.bool(true, '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_VAL_3_65          = input.float(3.65, '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_COL_3_65          = input.color(color.new(COLOR_PURPLE, TRANS_SUPP), '', inline='Level7', group=GROUP_FIB_LEVELS)
INPUT_SHOW_4_236        = input.bool(true, '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_VAL_4_236         = input.float(4.236, '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_COL_4_236         = input.color(color.new(COLOR_PINK, TRANS_SUPP), '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_SHOW_4_618        = input.bool(true, '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_VAL_4_618         = input.float(4.669, '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_COL_4_618         = input.color(color.new(COLOR_LIGHT_GREEN, TRANS_SUPP) , '', inline='Level8', group=GROUP_FIB_LEVELS)
INPUT_SHOW_NEG_0_236    = input.bool(true, '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_VAL_NEG_0_236     = input.float(-0.236, '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_COL_NEG_0_236     = input.color(color.new(COLOR_RED, TRANS_SUPP), '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_SHOW_NEG_0_382    = input.bool(true, '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_VAL_NEG_0_382     = input.float(-0.382, '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_COL_NEG_0_382     = input.color(color.new(COLOR_LIGHT_GREEN, TRANS_SUPP), '', inline='Level9', group=GROUP_FIB_LEVELS)
INPUT_SHOW_NEG_0_618    = input.bool(false, '', inline='Level10', group=GROUP_FIB_LEVELS)
INPUT_VAL_NEG_0_618     = input.float(-0.618, '', inline='Level10', group=GROUP_FIB_LEVELS)
INPUT_COL_NEG_0_618     = input.color(color.new(COLOR_TEAL, TRANS_SUPP), '', inline='Level10', group=GROUP_FIB_LEVELS)
INPUT_SHOW_NEG_0_65     = input.bool(true, '', inline='Level10', group=GROUP_FIB_LEVELS)
INPUT_VAL_NEG_0_65      = input.float(-0.65, '', inline='Level10', group=GROUP_FIB_LEVELS)
INPUT_COL_NEG_0_65      = input.color(color.new(COLOR_TEAL, TRANS_SUPP), '', inline='Level10', group=GROUP_FIB_LEVELS)

// ZigZag
INPUT_SHOW_ZIGZAG       = input.bool(true, 'Zig Zag‚Äá‚Äá', inline='ZZ', group=GROUP_ZIGZAG, tooltip=TOOLTIP_ZIGZAG)

// Alerts
INPUT_ALERT_ENABLED     = input.bool(false, 'Enable Alerts', group=GROUP_ALERTS)
INPUT_ALERT_MODE        = input.string('calculateAlertUpdates', 'Alert data collection mode', options=['calculateAlertData', 'calculateAlertUpdates'], group = GROUP_ALERTS)
INPUT_ALERT_SEPARATOR   = input.string('|', 'Alert data separator', group = GROUP_ALERTS)

// Volatility & Volume AddOns
INPUT_SHOW_HIGH_ATR     = input.bool(false, '‚ö°', inline='ATR', group=GROUP_VOL_VOL, tooltip=TOOLTIP_HIGH_VOL)
INPUT_ATR_LENGTH        = input.int(7, 'ATR : Length', inline='ATR', group=GROUP_VOL_VOL)
INPUT_ATR_MULT          = input.float(2.0, 'Mult', minval=.1, step=.1, inline='ATR', group=GROUP_VOL_VOL)
INPUT_VOL_SMA_LEN       = input.int(89, 'Volume Moving Average Length', group=GROUP_VOL_VOL)
INPUT_SHOW_VOL_SPIKE    = input.bool(false, 'üö¶', inline='SRS1', group=GROUP_VOL_VOL, tooltip=TOOLTIP_VOL_EXHAUST)
INPUT_VOL_SPIKE_THRESH  = input.float(2.5, 'Volume Spike Theshold‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá‚Äá', minval=.1, step=.1, inline='SRS1', group=GROUP_VOL_VOL)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULATIONS & LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Data Structures
var map<float, float> l_pivotLevelsLog_retracements = map.new<float, float>()
var map<float, float> l_pivotLevelsLog_crossed_retracements = map.new<float, float>()

type FibLevel
    float level
    color col
    bool show
    line ln = na
    label lb = na

var fibLevels = array.new<FibLevel>()
if barstate.isfirst
    fibLevels.push(FibLevel.new(INPUT_VAL_0, INPUT_COL_0, INPUT_SHOW_0))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_236, INPUT_COL_0_236, INPUT_SHOW_0_236))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_382, INPUT_COL_0_382, INPUT_SHOW_0_382))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_5, INPUT_COL_0_5, INPUT_SHOW_0_5))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_618, INPUT_COL_0_618, INPUT_SHOW_0_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_65, INPUT_COL_0_65, INPUT_SHOW_0_65))
    fibLevels.push(FibLevel.new(INPUT_VAL_0_786, INPUT_COL_0_786, INPUT_SHOW_0_786))
    fibLevels.push(FibLevel.new(INPUT_VAL_1, INPUT_COL_1, INPUT_SHOW_1))
    fibLevels.push(FibLevel.new(INPUT_VAL_1_272, INPUT_COL_1_272, INPUT_SHOW_1_272))
    fibLevels.push(FibLevel.new(INPUT_VAL_1_414, INPUT_COL_1_414, INPUT_SHOW_1_414))
    fibLevels.push(FibLevel.new(INPUT_VAL_1_618, INPUT_COL_1_618, INPUT_SHOW_1_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_1_65, INPUT_COL_1_65, INPUT_SHOW_1_65))
    fibLevels.push(FibLevel.new(INPUT_VAL_2_618, INPUT_COL_2_618, INPUT_SHOW_2_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_2_65, INPUT_COL_2_65, INPUT_SHOW_2_65))
    fibLevels.push(FibLevel.new(INPUT_VAL_3_618, INPUT_COL_3_618, INPUT_SHOW_3_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_3_65, INPUT_COL_3_65, INPUT_SHOW_3_65))
    fibLevels.push(FibLevel.new(INPUT_VAL_4_236, INPUT_COL_4_236, INPUT_SHOW_4_236))
    fibLevels.push(FibLevel.new(INPUT_VAL_4_618, INPUT_COL_4_618, INPUT_SHOW_4_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_NEG_0_236, INPUT_COL_NEG_0_236, INPUT_SHOW_NEG_0_236))
    fibLevels.push(FibLevel.new(INPUT_VAL_NEG_0_382, INPUT_COL_NEG_0_382, INPUT_SHOW_NEG_0_382))
    fibLevels.push(FibLevel.new(INPUT_VAL_NEG_0_618, INPUT_COL_NEG_0_618, INPUT_SHOW_NEG_0_618))
    fibLevels.push(FibLevel.new(INPUT_VAL_NEG_0_65, INPUT_COL_NEG_0_65, INPUT_SHOW_NEG_0_65))

int decimalsCount = math.round(math.abs(math.log(1 / syminfo.mintick) / math.log(10)))

// AddOn Logic: Volatility & Volume
i_weightedATR = ta.atr(INPUT_ATR_LENGTH) * INPUT_ATR_MULT
i_vSMA = ta.sma(nz(volume), INPUT_VOL_SMA_LEN)

nzVolume = nz(volume)
bullCandle = close > open
bearCandle = close < open
range_1 = math.abs(high - low)
exhaustVol = nzVolume > INPUT_VOL_SPIKE_THRESH * i_vSMA
bool crossover_exhaustion = ta.crossover(nzVolume, i_vSMA * INPUT_VOL_SPIKE_THRESH)
highVolatility = range_1 > i_weightedATR
bool crossover_volatility = ta.crossover(range_1, i_weightedATR)

// Variable Declarations
var line lineLast = na
var int iLast = 0
var int iPrev = 0
var float pLast = 0
var isHighLast = false 
var iPrevPivot = 0
var pPrevPivot = 0.
var iLastPivot = 0
var pLastPivot = 0.

// Track pivot changes to optimize drawing
var bool pivotChanged = false

// Cached pivot coordinates for stable Fibonacci drawing
var int cachedIMidPivot = na
var float cachedPMidPivot = na
var int cachedIEndBase = na
var float cachedPEndBase = na
var int cachedIMidPivot2 = na
var float cachedPMidPivot2 = na
var int cachedIEndBase2 = na
var float cachedPEndBase2 = na

// Determine Global Deviation Threshold based on Timeframe
float GLOBAL_DEV_THRESHOLD = switch
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "1S" => INPUT_DEV_THRESH_1S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "5S" => INPUT_DEV_THRESH_5S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "10S" => INPUT_DEV_THRESH_10S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "15S" => INPUT_DEV_THRESH_15S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "30S" => INPUT_DEV_THRESH_30S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "45S" => INPUT_DEV_THRESH_45S
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "1" => INPUT_DEV_THRESH_1M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "2" => INPUT_DEV_THRESH_2M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "3" => INPUT_DEV_THRESH_3M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "5" => INPUT_DEV_THRESH_5M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "10" => INPUT_DEV_THRESH_10M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "15" => INPUT_DEV_THRESH_15M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "30" => INPUT_DEV_THRESH_30M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "45" => INPUT_DEV_THRESH_45M
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "60" => INPUT_DEV_THRESH_1H
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "120" => INPUT_DEV_THRESH_2H
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "180" => INPUT_DEV_THRESH_3H
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "240" => INPUT_DEV_THRESH_4H
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "1D" => INPUT_DEV_THRESH_1D
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "7D" => INPUT_DEV_THRESH_7D
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "4W" => INPUT_DEV_THRESH_4W
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "3M" => INPUT_DEV_THRESH_3MO
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "6M" => INPUT_DEV_THRESH_6MO
    INPUT_CUSTOM_THRESHOLD and timeframe.period == "12M" => INPUT_DEV_THRESH_12MO
    => INPUT_DEV_THRESH_DEFAULT

// Determine Depth based on Timeframe
int i_depth = switch
    INPUT_CUSTOM_DEPTH and timeframe.period == "1S" => INPUT_DEPTH_1S
    INPUT_CUSTOM_DEPTH and timeframe.period == "5S" => INPUT_DEPTH_5S
    INPUT_CUSTOM_DEPTH and timeframe.period == "10S" => INPUT_DEPTH_10S
    INPUT_CUSTOM_DEPTH and timeframe.period == "15S" => INPUT_DEPTH_15S
    INPUT_CUSTOM_DEPTH and timeframe.period == "30S" => INPUT_DEPTH_30S
    INPUT_CUSTOM_DEPTH and timeframe.period == "45S" => INPUT_DEPTH_45S
    INPUT_CUSTOM_DEPTH and timeframe.period == "1" => INPUT_DEPTH_1M
    INPUT_CUSTOM_DEPTH and timeframe.period == "2" => INPUT_DEPTH_2M
    INPUT_CUSTOM_DEPTH and timeframe.period == "3" => INPUT_DEPTH_3M
    INPUT_CUSTOM_DEPTH and timeframe.period == "5" => INPUT_DEPTH_5M
    INPUT_CUSTOM_DEPTH and timeframe.period == "10" => INPUT_DEPTH_10M
    INPUT_CUSTOM_DEPTH and timeframe.period == "15" => INPUT_DEPTH_15M
    INPUT_CUSTOM_DEPTH and timeframe.period == "30" => INPUT_DEPTH_30M
    INPUT_CUSTOM_DEPTH and timeframe.period == "45" => INPUT_DEPTH_45M
    INPUT_CUSTOM_DEPTH and timeframe.period == "60" => INPUT_DEPTH_1H
    INPUT_CUSTOM_DEPTH and timeframe.period == "120" => INPUT_DEPTH_2H
    INPUT_CUSTOM_DEPTH and timeframe.period == "180" => INPUT_DEPTH_3H
    INPUT_CUSTOM_DEPTH and timeframe.period == "240" => INPUT_DEPTH_4H
    INPUT_CUSTOM_DEPTH and timeframe.period == "1D" => INPUT_DEPTH_1D
    INPUT_CUSTOM_DEPTH and timeframe.period == "7D" => INPUT_DEPTH_7D
    INPUT_CUSTOM_DEPTH and timeframe.period == "4W" => INPUT_DEPTH_4W
    INPUT_CUSTOM_DEPTH and timeframe.period == "3M" => INPUT_DEPTH_3MO
    INPUT_CUSTOM_DEPTH and timeframe.period == "6M" => INPUT_DEPTH_6MO
    INPUT_CUSTOM_DEPTH and timeframe.period == "12M" => INPUT_DEPTH_12MO
    => INPUT_DEPTH_DEFAULT

// Determine HTF
htf_auto = timeframe.period == '1'   ? '240' : 
           timeframe.period == '3'   ? '240' : 
           timeframe.period == '5'   ? '240' : 
           timeframe.period == '15'  ? 'D'   : 
           timeframe.period == '30'  ? 'D'   : 
           timeframe.period == '45'  ? 'D'   : 
           timeframe.period == '60'  ? 'W'   : 
           timeframe.period == '120' ? 'W'   : 
           timeframe.period == '180' ? 'W'   : 
           timeframe.period == '240' ? 'W'   : 
           timeframe.period == 'D'   ? 'M'   : 
           timeframe.period == 'W'   ? '3M'  : '12M'

htf = INPUT_HTF_MODE == 'Auto' ? htf_auto : htf_user_parsed

// Time Calculations
time_x10 = ta.valuewhen(ta.change(time(htf)) != 0, time, 1)
time_x11 = ta.valuewhen(ta.change(time(htf)) != 0, time, 0)
time_x21 = 2 * time_x11 - time_x10

var ln = array.new<line>()
var lb = array.new<label>()

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

pivotLength = math.max(1, int(math.round(i_depth / 2)))
pH = ta.pivothigh(high, pivotLength, pivotLength)
pL = ta.pivotlow(low, pivotLength, pivotLength)
iH = not na(pH) ? bar_index[pivotLength] : int(na)
iL = not na(pL) ? bar_index[pivotLength] : int(na)

calc_dev(float base_price, float price) =>
    100 * (price - base_price) / price
    
pivotFound(float dev, bool isHigh, int index, float price) =>
    float dev_threshold = GLOBAL_DEV_THRESHOLD
    if isHighLast == isHigh and not na(lineLast)
        if isHighLast ? price > pLast : price < pLast
            line.set_xy2(lineLast, index, price)
            [lineLast, isHighLast]
        else
            [line(na), bool(na)]
    else
        if na(lineLast)
            id = line.new(iLast, pLast, index, price, color=COLOR_ZZ, width=2, style=line.style_solid)
            [id, isHigh]
        else if math.abs(dev) > dev_threshold
            id = line.new(iLast, pLast, index, price, color=COLOR_ZZ, width=2, style=line.style_solid)
            [id, isHigh]
        else
            [line(na), bool(na)]

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRE-CALCULATION OF HISTORICAL PIVOT VALUES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

temp_iMidPivot_hist = INPUT_HIST_PIVOT > 0 ? ta.valuewhen(ta.change(iPrevPivot !=0), iPrevPivot, INPUT_HIST_PIVOT - 1) : int(na)
temp_pMidPivot_hist = INPUT_HIST_PIVOT > 0 ? ta.valuewhen(ta.change(pPrevPivot !=0), pPrevPivot, INPUT_HIST_PIVOT - 1) : float(na)
temp_iEndBase_hist = INPUT_HIST_PIVOT > 0 ? ta.valuewhen(ta.change(iLastPivot !=0), iLastPivot, INPUT_HIST_PIVOT - 1) : int(na)
temp_pEndBase_hist = INPUT_HIST_PIVOT > 0 ? ta.valuewhen(ta.change(pLastPivot !=0), pLastPivot, INPUT_HIST_PIVOT - 1) : float(na)

temp_iMidPivot2_hist = INPUT_HIST_PIVOT_2 > 0 ? ta.valuewhen(ta.change(iPrevPivot !=0), iPrevPivot, INPUT_HIST_PIVOT_2 - 1) : int(na)
temp_pMidPivot2_hist = INPUT_HIST_PIVOT_2 > 0 ? ta.valuewhen(ta.change(pPrevPivot !=0), pPrevPivot, INPUT_HIST_PIVOT_2 - 1) : float(na)
temp_iEndBase2_hist = INPUT_HIST_PIVOT_2 > 0 ? ta.valuewhen(ta.change(iLastPivot !=0), iLastPivot, INPUT_HIST_PIVOT_2 - 1) : int(na)
temp_pEndBase2_hist = INPUT_HIST_PIVOT_2 > 0 ? ta.valuewhen(ta.change(pLastPivot !=0), pLastPivot, INPUT_HIST_PIVOT_2 - 1) : float(na)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN PIVOT DETECTION AND ZIGZAG CONSTRUCTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

pivotChanged := false

if not na(iH)
    if na(lineLast) and pLast == 0
        iLast := iH
        pLast := pH
        isHighLast := true
    else
        dev = calc_dev(pLast, pH)
        [id, isHigh] = pivotFound(dev, true, iH, pH)
        if not na(id)
            if id != lineLast
                if not na(lineLast)
                    iPrevPivot := line.get_x1(lineLast)
                    pPrevPivot := line.get_y1(lineLast)
                    iLastPivot := line.get_x2(lineLast)
                    pLastPivot := line.get_y2(lineLast)
                else
                    iPrevPivot := iLast
                    pPrevPivot := pLast
                    iLastPivot := iH
                    pLastPivot := pH
                
                pivotChanged := true
                
                cachedIMidPivot := INPUT_HIST_PIVOT > 0 ? temp_iMidPivot_hist : iPrevPivot
                cachedPMidPivot := INPUT_HIST_PIVOT > 0 ? temp_pMidPivot_hist : pPrevPivot
                cachedIEndBase := INPUT_HIST_PIVOT > 0 ? temp_iEndBase_hist : iLastPivot
                cachedPEndBase := INPUT_HIST_PIVOT > 0 ? temp_pEndBase_hist : pLastPivot
                
                cachedIMidPivot2 := INPUT_HIST_PIVOT_2 > 0 ? temp_iMidPivot2_hist : iPrevPivot
                cachedPMidPivot2 := INPUT_HIST_PIVOT_2 > 0 ? temp_pMidPivot2_hist : pPrevPivot
                cachedIEndBase2 := INPUT_HIST_PIVOT_2 > 0 ? temp_iEndBase2_hist : iLastPivot
                cachedPEndBase2 := INPUT_HIST_PIVOT_2 > 0 ? temp_pEndBase2_hist : pLastPivot

                if not INPUT_SHOW_ZIGZAG and not na(lineLast)
                    line.delete(lineLast)
            else
                if INPUT_HIST_PIVOT == 0
                    cachedIEndBase := iH
                    cachedPEndBase := pH
                    cachedIEndBase2 := iH
                    cachedPEndBase2 := pH
                    pivotChanged := true 

            lineLast := id
            isHighLast := isHigh
            iPrev := iLast
            iLast := iH
            pLast := pH
else
    if not na(iL)
        if na(lineLast) and pLast == 0
            iLast := iL
            pLast := pL
            isHighLast := false
        else
            dev = calc_dev(pLast, pL)
            [id, isHigh] = pivotFound(dev, false, iL, pL)
            if not na(id)
                if id != lineLast
                    if not na(lineLast)
                        iPrevPivot := line.get_x1(lineLast)
                        pPrevPivot := line.get_y1(lineLast)
                        iLastPivot := line.get_x2(lineLast)
                        pLastPivot := line.get_y2(lineLast)
                    else
                        iPrevPivot := iLast
                        pPrevPivot := pLast
                        iLastPivot := iL
                        pLastPivot := pL
                    
                    pivotChanged := true
                    
                    cachedIMidPivot := INPUT_HIST_PIVOT > 0 ? temp_iMidPivot_hist : iPrevPivot
                    cachedPMidPivot := INPUT_HIST_PIVOT > 0 ? temp_pMidPivot_hist : pPrevPivot
                    cachedIEndBase := INPUT_HIST_PIVOT > 0 ? temp_iEndBase_hist : iLastPivot
                    cachedPEndBase := INPUT_HIST_PIVOT > 0 ? temp_pEndBase_hist : pLastPivot
                    
                    cachedIMidPivot2 := INPUT_HIST_PIVOT_2 > 0 ? temp_iMidPivot2_hist : iPrevPivot
                    cachedPMidPivot2 := INPUT_HIST_PIVOT_2 > 0 ? temp_pMidPivot2_hist : pPrevPivot
                    cachedIEndBase2 := INPUT_HIST_PIVOT_2 > 0 ? temp_iEndBase2_hist : iLastPivot
                    cachedPEndBase2 := INPUT_HIST_PIVOT_2 > 0 ? temp_pEndBase2_hist : pLastPivot

                    if not INPUT_SHOW_ZIGZAG and not na(lineLast)
                        line.delete(lineLast)
                else
                    if INPUT_HIST_PIVOT == 0
                        cachedIEndBase := iL
                        cachedPEndBase := pL
                        cachedIEndBase2 := iL
                        cachedPEndBase2 := pL
                        pivotChanged := true

                lineLast := id
                isHighLast := isHigh
                iPrev := iLast
                iLast := iL
                pLast := pL

f_htf_ohlc(string _htf) =>
    var htf_o  = 0.
    var htf_h  = 0.
    var htf_l  = 0.
    htf_c      = close
    
    var htf_ox = 0.
    var htf_hx = 0.
    var htf_lx = 0.
    var htf_cx = 0.

    if ta.change(time(_htf) !=0)
        htf_ox := htf_o
        htf_o  := open
        htf_hx := htf_h
        htf_h  := high
        htf_lx := htf_l
        htf_l  := low
        htf_cx := htf_c[1]
        htf_cx
    else
        htf_h := math.max(high, htf_h)
        htf_l := math.min(low , htf_l)
        htf_l

    [htf_ox, htf_hx, htf_lx, htf_cx, htf_o, htf_h, htf_l, htf_c]

[_, htf_h1, htf_l1, htf_c1, _, _, _, _] = f_htf_ohlc(htf)

f_get_level(float _ratio) =>
    float _diff = math.abs(cachedPMidPivot - cachedPEndBase)
    float _result = cachedPEndBase < cachedPMidPivot ? 
         (INPUT_REVERSE ? cachedPEndBase : cachedPMidPivot) - (INPUT_REVERSE ? -1 : 1) * _diff * _ratio : 
         (INPUT_REVERSE ? cachedPEndBase : cachedPMidPivot) + (INPUT_REVERSE ? -1 : 1) * _diff * _ratio
    _result

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIVOT COORDINATE REFERENCES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

iMidPivot  = cachedIMidPivot
pMidPivot  = cachedPMidPivot
iEndBase   = cachedIEndBase
pEndBase   = cachedPEndBase
iMidPivot2 = cachedIMidPivot2
pMidPivot2 = cachedPMidPivot2
iEndBase2  = cachedIEndBase2
pEndBase2  = cachedPEndBase2

f_crossingLevel(float _curret, float _level) =>
    _level > _curret and _level < _curret[1] or _level < _curret and _level > _curret[1]

if ta.change(time) != 0 and array.size(ln) > 0
    for i = 1 to array.size(ln) by 1
        line.delete(array.shift(ln))

if ta.change(time) != 0 and array.size(lb) > 0
    for i = 1 to array.size(lb) by 1
        label.delete(array.shift(lb))

f_drawLineTZ(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w) =>
    if _x1 - bar_index < 500
        array.push(ln, line.new(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w))

f_drawLabelTZ(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip) =>
    if _x - bar_index < 500
        array.push(lb, label.new(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip))

f_drawLinePVT(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w) =>
    if _y1 > 0
        array.push(ln, line.new(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w))

f_drawLabelPVT(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip) =>
    if _y > 0
        array.push(lb, label.new(_x, _y, INPUT_EXTEND_PVT or INPUT_LEVELS_PVT_POS == "Last Bar" ? _text + '\n\n' : _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip))

f_setLog(map<float, float> logMap) => 
    logMap.clear()

f_updateLevelsLog(map<float, float> logMap, float level, float value) =>
    logMap.put(level, value)

method draw(FibLevel this, int x1, float pMid, int x2, float pEnd, bool forceRedraw) =>
    if this.show and not na(x1) and not na(pMid) and not na(pEnd)
        pPivotDiff = math.abs(pMid - pEnd)
        price = 0.
        price := pEnd < pMid ? (INPUT_REVERSE ? pEnd : pMid) - (INPUT_REVERSE ? -1 : 1) * pPivotDiff * this.level : (INPUT_REVERSE ? pEnd : pMid) + (INPUT_REVERSE ? -1 : 1) * pPivotDiff * this.level
        price := math.round_to_mintick(price)
        
        if forceRedraw
            if not na(this.ln)
                line.delete(this.ln)
                this.ln := na
            if not na(this.lb)
                label.delete(this.lb)
                this.lb := na
            if price > 0
                this.ln := line.new(x1, price, x2, price, xloc.bar_index, INPUT_EXTEND_ER ? extend.both : extend.right, this.col, line.style_solid, this.level != 1 ? 1 : 2)
            if INPUT_LEVELS_LABEL != 'None' and price > 0
                bar_pos = INPUT_LEVELS_POS == "Last Bar" ? x2 : x1
                style_lbl = INPUT_LEVELS_POS == "Last Bar" ? label.style_label_left : label.style_label_right
                size_lbl = INPUT_LEVELS_SIZE == 'Small' ? size.small : size.normal
                text_str = (INPUT_LEVELS_LABEL == 'Prices' ? '' : 'RET ' + str.tostring(this.level)) + (INPUT_LEVELS_LABEL == 'Levels + Prices' or INPUT_LEVELS_LABEL == 'Prices' ? ' (' + str.tostring(price, format.mintick) + ')' : '')
                tooltip_str = str.tostring(price, format.mintick)
                this.lb := label.new(bar_pos, price, INPUT_EXTEND_PVT or INPUT_EXTEND_ER or INPUT_LEVELS_POS == 'Last Bar' ? text_str + '\n\n' : text_str, xloc.bar_index, yloc.price, color.new(COLOR_FG_MAIN, 100), style_lbl, color.new(COLOR_FG_MAIN, 0), size_lbl, text.align_right, tooltip_str)
        else
            if not na(this.ln) and price > 0
                line.set_x2(this.ln, x2)
            if INPUT_LEVELS_POS == "Last Bar" and not na(this.lb) and price > 0
                label.set_x(this.lb, x2)
        
        f_updateLevelsLog(l_pivotLevelsLog_retracements, this.level, price)
        if f_crossingLevel(close, price)
            f_updateLevelsLog(l_pivotLevelsLog_crossed_retracements, this.level, price)

f_logToJson(map<float, float> logMap) => 
    result = '{'
    for i = 0 to array.size(fibLevels) - 1
        lvl = array.get(fibLevels, i)
        val = logMap.get(lvl.level)
        levelKey = str.replace(str.tostring(lvl.level), '.', '_')
        if na(val)
            result := result + '"' + levelKey + '":null'
        else
            result := result + '"' + levelKey + '":' + str.tostring(val)
        if i < array.size(fibLevels) - 1
            result := result + ','
    result + '}'

f_getAlertMessage(string id) =>
    string barstate_json = (
        '{"is_new":' + (barstate.isnew ? 'true' : 'false') + 
        ',"is_first":' + (barstate.isfirst ? 'true' : 'false') + 
        ',"is_last":' + (barstate.islast ? 'true' : 'false') + 
        ',"is_confirmed":' + (barstate.isconfirmed ? 'true' : 'false') + 
        ',"is_history":' + (barstate.ishistory ? 'true' : 'false') + 
        '}')
    string ohlcv_json = (
        '{"open":' + str.tostring(open) + 
        ',"high":' + str.tostring(high) + 
        ',"low":' + str.tostring(low) + 
        ',"close":' + str.tostring(close) + 
        ',"hl2":' + str.tostring(hl2) + 
        ',"hlc3":' + str.tostring(hlc3) + 
        ',"hlcc4":' + str.tostring(hlcc4) + 
        ',"ohlc4":' + str.tostring(ohlc4) + 
        ',"volume":' + str.tostring(volume) + '}')
    string base_json = ('"event_id":"' + id + '"' +
                        ',"bar_index":' + str.tostring(bar_index) + 
                        ',"last_bar_index":' + str.tostring(last_bar_index) + 
                        ',"time_tradingday":' + str.tostring(time_tradingday) + 
                        ',"time_close":' + str.tostring(time_close) + 
                        ',"session_is_first_bar":' + (session.isfirstbar ? 'true' : 'false') + 
                        ',"barstate":' + barstate_json + 
                        ',"ohlcv":' + ohlcv_json)
    string log = ''
    if id == ALERT_ID_UPDATE
        log := ('{' + base_json + 
                ',"retracements":' + f_logToJson(l_pivotLevelsLog_retracements) + 
                ',"crossed_retracements":' + f_logToJson(l_pivotLevelsLog_crossed_retracements) + '}')
    if id == ALERT_ID_EXHAUSTION
        log := ('{' + base_json + 
                ',"bull_candle":' + (bullCandle ? 'true' : 'false') + 
                ',"bear_candle":' + (bearCandle ? 'true' : 'false') + 
                ',"exhaust_vol":' + (exhaustVol ? 'true' : 'false') + '}')
    if id == ALERT_ID_VOLATILITY
        log := ('{' + base_json + 
                ',"bull_candle":' + (bullCandle ? 'true' : 'false') + 
                ',"bear_candle":' + (bearCandle ? 'true' : 'false') + 
                ',"high_volatility":' + (highVolatility ? 'true' : 'false') + '}')
    if id == ALERT_ID_CROSSING
        log := ('{' + base_json + 
                ',"crossed_retracements":' + f_logToJson(l_pivotLevelsLog_crossed_retracements) + '}')
    log

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLOT EXECUTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if INPUT_SHOW_FIB_TIME
    t_lineTZ_style = line.style_dotted
    t_lineTZ_width = 1
    t_lineTZ_color = color.new(COLOR_FG_MAIN, 50)
    referance = math.round(iEndBase2 - iMidPivot2)
    f_drawLineTZ(_x1=iMidPivot2 - referance        , _y1=pEndBase2, _x2=iMidPivot2 - referance       , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2                    , _y1=pEndBase2, _x2=iMidPivot2                   , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=t_lineTZ_color, _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance        , _y1=pEndBase2, _x2=iMidPivot2 + referance       , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=t_lineTZ_color, _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 2    , _y1=pEndBase2, _x2=iMidPivot2 + referance * 2 , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 3    , _y1=pEndBase2, _x2=iMidPivot2 + referance * 3 , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 5    , _y1=pEndBase2, _x2=iMidPivot2 + referance * 5 , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 8    , _y1=pEndBase2, _x2=iMidPivot2 + referance * 8 , _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 13   , _y1=pEndBase2, _x2=iMidPivot2 + referance * 13, _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 21   , _y1=pEndBase2, _x2=iMidPivot2 + referance * 21, _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 34   , _y1=pEndBase2, _x2=iMidPivot2 + referance * 34, _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 55   , _y1=pEndBase2, _x2=iMidPivot2 + referance * 55, _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)
    f_drawLineTZ(_x1=iMidPivot2 + referance * 89   , _y1=pEndBase2, _x2=iMidPivot2 + referance * 89, _y2=pMidPivot2, _xloc=xloc.bar_index, _extend=extend.both, _c=COLOR_TZ , _s=t_lineTZ_style, _w=t_lineTZ_width)

    if INPUT_FIB_TZ_LABEL
        t_labelTZ_background = color.new(COLOR_FG_MAIN, 100)
        t_labelTZ_text_align = text.align_center
        t_labelTZ_size = size.small
        t_labelTZ_color = color.new(COLOR_FG_MAIN, 0)
        f_drawLabelTZ(_x=iMidPivot2 + referance * -1, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='-1', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 0 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='0' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=t_labelTZ_color, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 1 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='1' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=t_labelTZ_color, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 2 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='2' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 3 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='3' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 5 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='5' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 8 , _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='8' , _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 13, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='13', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 21, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='21', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 34, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='34', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 55, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='55', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')
        f_drawLabelTZ(_x=iMidPivot2 + referance * 89, _y=INPUT_FIB_TZ_POS_Y == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), _text='89', _xloc=xloc.bar_index, _yloc=yloc.price, _color=t_labelTZ_background, _style=fib_tzlp, _textcolor=COLOR_TZ, _size=t_labelTZ_size, _textalign=t_labelTZ_text_align, _tooltip='')

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CACHED COORDINATE INITIALIZATION AND UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if not na(lineLast)
    currentX1 = line.get_x1(lineLast)
    currentY1 = line.get_y1(lineLast)
    currentX2 = line.get_x2(lineLast)
    currentY2 = line.get_y2(lineLast)
    
    if na(cachedIMidPivot) or pivotChanged
        cachedIMidPivot := iPrevPivot != 0 ? iPrevPivot : currentX1
        cachedPMidPivot := pPrevPivot != 0 ? pPrevPivot : currentY1
        cachedIEndBase := iLastPivot != 0 ? iLastPivot : currentX2
        cachedPEndBase := pLastPivot != 0 ? pLastPivot : currentY2
        cachedIMidPivot2 := iPrevPivot != 0 ? iPrevPivot : currentX1
        cachedPMidPivot2 := pPrevPivot != 0 ? pPrevPivot : currentY1
        cachedIEndBase2 := iLastPivot != 0 ? iLastPivot : currentX2
        cachedPEndBase2 := pLastPivot != 0 ? pLastPivot : currentY2

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIBONACCI LEVEL DRAWING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if not na(cachedIMidPivot) and not na(cachedPEndBase)
    bool needsFullRedraw = pivotChanged or na(array.get(fibLevels, 0).ln)
    for lvl in fibLevels
        lvl.draw(cachedIMidPivot, cachedPMidPivot, bar_index, cachedPEndBase, needsFullRedraw)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATISTICAL POSITION ENGINE (NEW)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var box box_entry = na
var line line_sl = na
var line line_tp = na
var label lbl_risk = na

if INPUT_SHOW_POS and not na(cachedIMidPivot) and not na(cachedPEndBase)
    bool is_long_setup = cachedPEndBase > cachedPMidPivot
    float price_618 = f_get_level(0.618)
    float price_65  = f_get_level(0.65)
    
    float current_atr = ta.atr(INPUT_ATR_LENGTH)
    float sl_price = is_long_setup ? cachedPMidPivot - (current_atr * INPUT_POS_SL_MULT) : cachedPMidPivot + (current_atr * INPUT_POS_SL_MULT)
    float tp_price = INPUT_POS_TP_MODE == 'Conservative' ? cachedPEndBase : f_get_level(-0.272)

    if pivotChanged or na(box_entry)
        box.delete(box_entry)
        line.delete(line_sl)
        line.delete(line_tp)
        label.delete(lbl_risk)

        box_entry := box.new(bar_index, price_618, bar_index + 5, price_65, 
             bgcolor=color.new(is_long_setup ? COLOR_BLUE : COLOR_RED, 75), 
             border_color=color.new(is_long_setup ? COLOR_BLUE : COLOR_RED, 25),
             border_style=line.style_dotted)

        line_sl := line.new(bar_index, sl_price, bar_index + 5, sl_price, color=color.new(COLOR_RED, 5), style=line.style_dotted, width = 2)
        line_tp := line.new(bar_index, tp_price, bar_index + 5, tp_price, color=color.new(COLOR_GREEN, 5), style=line.style_dotted, width = 2)
        
        // CHANGED: Position label at the center of the entry zone for better readability
        float mid_entry = (price_618 + price_65) / 2
        string pos_text = (is_long_setup ? "LONG" : "SHORT") + " SETUP\nTP: " + str.tostring(tp_price, format.mintick) + "\nSL: " + str.tostring(sl_price, format.mintick)
        lbl_risk := label.new(bar_index + 5, mid_entry, pos_text, xloc.bar_index, yloc.price, color.new(COLOR_FG_MAIN, 100), label.style_label_left, color.new(COLOR_FG_MAIN, 0), size.small)

    else
        if not na(box_entry)
            box.set_right(box_entry, bar_index + 5)
        if not na(line_sl)
            line.set_x2(line_sl, bar_index + 5)
        if not na(line_tp)
            line.set_x2(line_tp, bar_index + 5)
        if not na(lbl_risk)
            label.set_x(lbl_risk, bar_index + 5)

// AddOns
plotchar(INPUT_SHOW_VOL_SPIKE and nzVolume != 0 ? exhaustVol : false, 'Exhaustion Bar', 'üö¶', location.abovebar, size=size.tiny, display = display.pane)
plotchar(INPUT_SHOW_HIGH_ATR ? highVolatility : false, 'High Volatile Bar', '‚ö°', location.belowbar, size=size.tiny, display = display.pane)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATUS LINE VALUES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

v_start = cachedPMidPivot
v_end   = cachedPEndBase
v_50    = f_get_level(0.5)
v_618   = f_get_level(0.618)

plot(v_start, "Pivot Start", color = color.new(color.gray, 0), display = display.data_window + display.status_line)
plot(v_end,   "Pivot End",   color = color.new(color.white, 0), display = display.data_window + display.status_line)
plot(v_50,    "Fib 0.50",    color = color.new(color.yellow, 0), display = display.data_window + display.status_line)
plot(v_618,   "Fib 0.618",   color = color.new(color.orange, 0), display = display.data_window + display.status_line)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if INPUT_ALERT_ENABLED and INPUT_ALERT_MODE == 'calculateAlertUpdates'
    if barstate.isconfirmed
        alert(f_getAlertMessage(ALERT_ID_UPDATE), alert.freq_once_per_bar) 
    
    if barstate.ishistory
        f_setLog(l_pivotLevelsLog_retracements)
        f_setLog(l_pivotLevelsLog_crossed_retracements)